apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: operator-pod-restart
spec:
  description: Restart Kuadrant/RHCL operator pod to make sure everything gets reconciled successfully
  params:
    - name: kubeconfig-path
      type: string
  steps:
    - computeResources:
        limits:
          cpu: '100m'
          memory: 128Mi
      env:
        - name: KUBECONFIG
          value: $(params.kubeconfig-path)
      image: quay.io/kuadrant/testsuite-pipelines-tools:latest
      imagePullPolicy: Always
      name: operator-pod-restart
      script: |
        #!/usr/bin/env bash
        set -evo pipefail

        # Get the namespace of the Subscription (typically kuadrant-system but it can be different)
        namespace=$(kubectl get subscription --all-namespaces -o json | jq -r '.items[] | select(.metadata.name == "kuadrant-operator") | .metadata.namespace')
        if [[ -z "$namespace" ]]; then
            echo "Subscription 'kuadrant-operator' not found in any namespace."
            exit 1
        fi

        # Delete the operator Pod(s) - the one(s) with app=kuadrant label
        kubectl delete pod -l app=kuadrant --wait=true -n $namespace

        # Wait for a new Pod to get up and running
        kubectl wait --for=condition=Ready pod -l app=kuadrant --timeout=300s -n $namespace
  workspaces:
    - name: shared-workspace

