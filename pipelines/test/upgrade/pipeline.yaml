apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: test-upgrade
spec:
  params:
# Cluster related parameters
    - description: API URL of the Openshift cluster
      name: kube-api
      type: string
    - description: Secret name with cluster credentials
      name: cluster-credentials
      type: string
      default: openshift-pipelines-credentials
# Kuadrant/RHCL installation/upgrade related parameters
    - default: ""
      description: Kuadrant/RHCL index image, must contain proper bundle chain for upgrade
      name: index-image
      type: string
    - default: stable
      description: Kuadrant channel (stable, preview)
      name: channel
      type: string
    - default: rhcl-operator
      description: Operator name (kuadrant-operator, rhcl-operator)
      name: operator-name
      type: string
    - default: ossm3
      description: Istio provider (ossm3, ocp); 'ossm3' (recommended for all Openshift versions), 'ocp' for installing Istio managed by Gateway API on OCP v4.19+ (not recommended - mTLS is not supported)
      name: istio-provider
      type: string
    - default: ""
      description: GatewayAPI CRD version. [v1.2.1, v1.3.0, v1.4.0] available; leave empty if installing on Openshift 4.19+.
      name: gateway-crd
      type: string
    - default: "--set=kuadrant.installPlanApproval=Manual --set=kuadrant.startingCSV=rhcl-operator.v1.2.1"
      description: Additional flags for helm install command, update default value for desired "upgrade from" version here as needed
      name: additional-helm-flags
      type: string
    - default: ""
      description: Additional flags for tools helm, example '--set=tools.keycloak.keycloakProvider=deployment --set=tools.valkey.enable=false'"
      name: additional-helm-tools-flags
      type: string
# Testsuite related parameters
    - default: 'quay.io/kuadrant/testsuite:unstable'
      description: Testsuite image
      name: testsuite-image
      type: string
    - default: kuadrant
      description: Openshift project
      name: project
      type: string
    - default: smoke
      description: Makefile target for pre-upgrade tests
      name: pre-upgrade-make-target
      type: string
    - default: test
      description: Makefile target for post-upgrade tests
      name: post-upgrade-make-target
      type: string
    - default: ""
      description: Pytest flags to use with Make (flags="${pytest-flags}" make kuadrant)
      name: pytest-flags
      type: string
    - default: pipeline-settings
      description: Config Map with settings for the testsuite
      name: settings-cm
      type: string
    - default: ""
      description: Additional env for testsuite container separated with spaces (e.g. KUADRANT_CONTROL_PLANE__provider_secret=gcp-credentials KUADRANT_KEYCLOAK__url="https://my-sso.net")
      name: additional-env
      type: string
# Report Portal related parameters
    - default: full-cycle-upgrade
      description: Prefix of the launch name saved in report portal (nightly, username, manual, etc.). In case of release candidate testing use kuadrant-v<version>, rhcl-v<version>, or authorino-v<version>
      name: launch-name
      type: string
    - default: ""
      description: Optional launch description for Report Portal
      name: launch-description
      type: string
    - default: testsuite
      description: Report Portal Project to store test results (e.g. testsuite, nightly-testsuite, releases)
      name: rp-project
      type: string
    - default: true
      description: If set to 'true' upload test results to Report Portal
      name: upload-results
      type: string
  workspaces:
    - name: shared-workspace
  tasks:
    - name: check-image-existence
      when:
        - input: "$(params.index-image)"
          operator: notin
          values: ['']
      params:
        - name: index-image
          value: $(params.index-image)
      taskRef:
        kind: Task
        name: check-image-existence
    - name: kubectl-login
      params:
        - name: kube-api
          value: $(params.kube-api)
        - name: testsuite-image
          value: 'quay.io/kuadrant/testsuite-pipelines-tools:latest'
        - name: cluster-credentials
          value: $(params.cluster-credentials)
      taskRef:
        kind: Task
        name: kubectl-login
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: helm-deploy
      params:
        - name: index-image
          value: $(params.index-image)
        - name: channel
          value: $(params.channel)
        - name: istio-provider
          value: $(params.istio-provider)
        - name: operator-name
          value: $(params.operator-name)
        - name: kubeconfig-path
          value: $(tasks.kubectl-login.results.kubeconfig-path)
        - name: gateway-crd
          value: $(params.gateway-crd)
        - name: additional-helm-flags
          value: $(params.additional-helm-flags)
        - name: additional-helm-tools-flags
          value: $(params.additional-helm-tools-flags)
      runAfter:
        - kubectl-login
        - check-image-existence
      taskRef:
        kind: Task
        name: helm-deploy
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: operator-pod-restart
      retries: 3
      params:
        - name: kubeconfig-path
          value: $(tasks.kubectl-login.results.kubeconfig-path)
      runAfter:
        - helm-deploy
      taskRef:
        kind: Task
        name: operator-pod-restart
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: run-tests-pre-upgrade
      params:
        - name: testsuite-image
          value: $(params.testsuite-image)
        - name: project
          value: $(params.project)
        - name: make-target
          value: $(params.pre-upgrade-make-target)
        - name: pytest-flags
          value: $(params.pytest-flags)
        - name: settings-cm
          value: $(params.settings-cm)
        - name: additional-env
          value: $(params.additional-env)
        - name: kubeconfig-path
          value: $(tasks.kubectl-login.results.kubeconfig-path)
        - name: cluster-credentials
          value: $(params.cluster-credentials)
      runAfter:
        - operator-pod-restart
      taskRef:
        kind: Task
        name: run-tests
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: pause-pipeline-pre-upgrade
      runAfter:
        - run-tests-pre-upgrade
      taskRef:
        kind: Task
        name: pause-pipeline
    - name: upgrade-to-latest
      params:
        - name: kubeconfig-path
          value: $(tasks.kubectl-login.results.kubeconfig-path)
      runAfter:
        - pause-pipeline-pre-upgrade
      taskRef:
        kind: Task
        name: upgrade-to-latest
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: pause-pipeline-post-upgrade
      runAfter:
        - upgrade-to-latest
      taskRef:
        kind: Task
        name: pause-pipeline
    - name: run-tests-post-upgrade
      params:
        - name: testsuite-image
          value: $(params.testsuite-image)
        - name: project
          value: $(params.project)
        - name: make-target
          value: $(params.post-upgrade-make-target)
        - name: pytest-flags
          value: $(params.pytest-flags)
        - name: settings-cm
          value: $(params.settings-cm)
        - name: additional-env
          value: $(params.additional-env)
        - name: kubeconfig-path
          value: $(tasks.kubectl-login.results.kubeconfig-path)
        - name: cluster-credentials
          value: $(params.cluster-credentials)
      runAfter:
        - pause-pipeline-post-upgrade
      taskRef:
        kind: Task
        name: run-tests
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace
    - name: upload-results
      when:
        - input: $(params.upload-results)
          operator: in
          values: ["true"]
      params:
        - name: launch-name
          value: $(params.launch-name)
        - name: launch-description
          value: $(params.launch-description)
        - name: testsuite-image
          value: $(params.testsuite-image)
        - name: make-target
          value: $(params.post-upgrade-make-target)
        - name: rp-project
          value: $(params.rp-project)
        - name: ocp-version
          value: $(tasks.kubectl-login.results.ocp-version)
      runAfter:
        - run-tests-post-upgrade
      taskRef:
        kind: Task
        name: upload-results
      workspaces:
        - name: shared-workspace
          workspace: shared-workspace

